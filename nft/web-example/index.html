<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NFT Marketplace</title>
    <script type="text/javascript" src="libs/tonweb-0.0.29.js"></script>
</head>
<body>

<!-- Create/Edit My Collection -->

<div id="createCollectionScreen">
    <h1>Create a Collection</h1>
    <div>
        <div>
            Logo image*
            This image will also be used for navigation. 350 x 350 recommended.
        </div>
        <input type="file">
    </div>
    <div>
        <div>
            Featured image
            This image will be used for featuring your collection on the homepage, category pages, or other promotional
            areas of Marketplace. 600 x 400 recommended.
        </div>
        <input type="file">
    </div>
    <div>
        <div>
            Banner image
            This image will appear at the top of your collection page. Avoid including too much text in this banner
            image, as the dimensions change on different devices. 1400 x 400 recommended.
        </div>
        <input type="file">
    </div>
    <div>
        <div>
            Name*
        </div>
        <input type="text" placeholder="Example: Treasures of the Sea">
    </div>
    <div>
        <div>
            URL
            Customize your URL on Marketplace. Must only contain lowercase letters,numbers, and hyphens.
        </div>
        <input type="text" placeholder="https://marketplace.io/collection/">
    </div>
    <div>
        <div>
            Description
            Markdown syntax is supported. 0 of 1000 characters used.
        </div>
        <textarea></textarea>
    </div>
    <div>
        <div>
            Category
            Adding a category will help make your item discoverable on Marketplace.
        </div>
        <select>
            <option>Art</option>
            <option>Collectibles</option>
            <option>Music</option>
            <option>Photography</option>
            <option>Sports</option>
            <option>Trading Cards</option>
            <option>Utility</option>
        </select>
    </div>
    <div>
        <div>
            WebSite Link
        </div>
        <input type="text">
    </div>
    <div>
        <div>
            Telegram Channel/Group Link
        </div>
        <input type="text">
    </div>
    <div>
        <div>
            Instagram Link
        </div>
        <input type="text">
    </div>
    <div>
        <div>
            Medium Link
        </div>
        <input type="text">
    </div>
    <div>
        <div>
            Creator Earnings
            Collect a fee when a user re-sells an item you originally created. This is deducted from the final sale
            price and paid monthly to a payout address of your choosing.
        </div>
        <input type="number" placeholder="e.g 2.5">
    </div>
    <div>
        <div>
            Your payout wallet address
        </div>
        <input type="text">
    </div>
    <div>
        <div>
            Payment tokens
            These tokens can be used to buy and sell your items.
        </div>
        <input type="text" disabled>
    </div>
    <div>
        <div>
            Explicit & sensitive content
            Set this collection as explicit and sensitive content
            info
        </div>
        <input type="checkbox">
    </div>

    <button id="createCollectionButton">Create</button>
</div>


<div id="createNftScreen">
    <h1>Create New Item</h1>
    <div>
        <div>
            Image, Video, Audio, or 3D Model
            File types supported: JPG, PNG, GIF, SVG, MP4, WEBM, MP3, WAV, OGG, GLB, GLTF. Max size: 100 MB
        </div>
        <input type="file">
    </div>
    <div>
        <div>
            Name*
        </div>
        <input type="text" placeholder="Item Name">
    </div>
    <div>
        <div>
            External link
            Marketplace will include a link to this URL on this item's detail page, so that users can click to learn more
            about it. You are welcome to link to your own webpage with more details.
        </div>
        <input type="text" placeholder="https://yoursite.io/item/123">
    </div>
    <div>
        <div>
            Description
            The description will be included on the item's detail page underneath its image. Markdown syntax is
            supported.
        </div>
        <textarea placeholder="Provide a detailed description of your item"></textarea>
    </div>
    <div>
        <div>
            Collection
            This is the collection where your item will appear.
        </div>
        <select></select>
    </div>
    <div>
        <div>
            Properties
            Textual traits that show up as rectangles
        </div>
    </div>
    <div>
        <div>
            Levels
            Numerical traits that show as a progress bar
        </div>
    </div>
    <div>
        <div>
            Stats
            Numerical traits that just show as numbers
        </div>
    </div>
    <div>
        <div>
            Unlockable Content
            Include unlockable content that can only be revealed by the owner of the item.
        </div>
        <input type="text" placeholder="Enter content (access key, code of redeem, link to a file, etc.)">
    </div>
    <div>
        <div>
            Explicit & sensitive content
            Set this collection as explicit and sensitive content
            info
        </div>
        <input type="checkbox">
    </div>
    <div>
        <div>
            Supply
            The number of items that can be minted.
        </div>
        <input type="number" value="1">
    </div>
    <div>
        <div>
            [Coming Soon] Freeze metadata in TON Storage
        </div>
    </div>
    <button id="createNftButton">Create</button>
</div>

<!-- Transfer Item -->


<div id="createSaleScreen">
    <h1>List item for sale</h1>

    <div>
        <div>
            Type
        </div>
        <!--            Fixed Price-->
        <!--            Timed Auction-->
    </div>
    <div>
        <div>
            Method
        </div>
        <!--            Sell to highest bidder -->
        <!--            Sell with declining price -->
    </div>

    <div>
        <div>
            Price
        </div>
        Toncoin
        <input type="number" value="1">
    </div>
    <div>
        <div>
            Duration
        </div>
        <input type="number" value="1"> days
    </div>

    <div>
        Fees
        info
        Service Fee
        2.5%
        Creator Royalty
        9.9%
    </div>

    <button>Sale</button>
</div>

<div id="mainScreen">
    <button id="showCreateCollectionButton">Create Collection</button>
    <button id="showCreateNftButton">Create NFT</button>
</div>

<script>
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selectors) => document.querySelectorAll(selectors);


    // BLOCKCHAIN

    const provider = window.ton;

    if (!provider) {
        alert('TON Wallet Plugin not installed');
        throw new Error('TON Wallet Plugin not installed');
    }

    const {NftCollection, NftItem, NftMarketplace, NftSale} = TonWeb.token.nft;

    console.log(TonWeb.token.nft)

    const tonweb = new TonWeb(new TonWeb.HttpProvider('https://testnet.toncenter.com/api/v2/jsonRPC'));

    const init = async () => {
        const accounts = await provider.send('ton_requestAccounts');
        const walletAddress = new TonWeb.utils.Address(accounts[0]);
        console.log('wallet address=', walletAddress.toString(true, true, true));

        const nftCollection = new NftCollection(tonweb.provider, {
            ownerAddress: walletAddress,
            royalty: 0.13,
            royaltyAddress: walletAddress,
            uri: 'http://localhost:63342/nft-marketplace/my_collection.json',
            nftItemCodeHex: NftItem.codeHex
        });
        const nftCollectionAddress = await nftCollection.getAddress();
        console.log('collection address=', nftCollectionAddress.toString(true, true, true));

        const deployNftCollection = async () => {
            const stateInit = (await nftCollection.createStateInit()).stateInit;
            const stateInitBoc = await stateInit.toBoc();
            const stateInitBase64 = TonWeb.utils.bytesToBase64(stateInitBoc);

            provider.send(
                'ton_sendTransaction',
                [{
                    to: nftCollectionAddress.toString(true, true, false), // non-bounceable
                    value: TonWeb.utils.toNano(0.05).toString(),
                    stateInit: stateInitBase64,
                    dataType: 'boc'
                }]
            );
        }

        const deployNftItem = async () => {
            const amount = TonWeb.utils.toNano(0.05);

            const body = await nftCollection.createMintBody({
                index: 0,
                amount: amount,
                ownerAddress: walletAddress,
                uri: 'http://localhost:63342/nft-marketplace/my_nft.json'
            });
            const bodyBoc = await body.toBoc();
            const bodyBase64 = TonWeb.utils.bytesToBase64(bodyBoc);
            console.log(bodyBase64);

            provider.send(
                'ton_sendTransaction',
                [{
                    to: nftCollectionAddress.toString(true, true, true),
                    value: amount.toString(),
                    data: bodyBase64,
                    dataType: 'boc'
                }]
            );
        }

        // VIEW

        const showScreen = (name) => {
            $('#createCollectionScreen').style.display = name === 'createCollectionScreen' ? 'block' : 'none';
            $('#createNftScreen').style.display = name === 'createNftScreen' ? 'block' : 'none';
            $('#createSaleScreen').style.display = name === 'createSaleScreen' ? 'block' : 'none';
            $('#mainScreen').style.display = name === 'mainScreen' ? 'block' : 'none';
        }

        $('#showCreateCollectionButton').addEventListener('click', () => showScreen('createCollectionScreen'));
        $('#showCreateNftButton').addEventListener('click', () => showScreen('createNftScreen'));

        $('#createCollectionButton').addEventListener('click', async () => {
            // 1. make Metadata JSON from user's inputs
            // 2. host Metadata JSON and content files on marketplace side (like my_collection.json)
            // 3. deploy NFT Collection smart contract with URI setted to this Metadata JSON file

            await deployNftCollection();
            showScreen('mainScreen');
        });
        $('#createNftButton').addEventListener('click', async () => {
            // 1. make MetadataJSON from user's inputs
            // 2. host Metadata JSON and content files on marketplace side (like my_nft.json)
            // 3. mint NFT smart contract with URI setted to this Metadata JSON file by invoking collection smart contract

            await deployNftItem();
            showScreen('mainScreen');
        });

        showScreen('mainScreen');
    }

    init();
</script>


</body>
</html>